name: Push to CDN
on:
  push:
    branches:
      - 'chore/publish-to-cdn'
    paths:
      - 'frontend/app-development/**'
      - 'frontend/app-preview/**'
      - 'frontend/dashboard/**'
      - 'frontend/language/**'
      - 'frontend/packages/**'
      - '.github/workflows/push-to-cdn.yml'
      - 'package.json'

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build
    steps:
      - name: 'Checking Out Code'
        uses: actions/checkout@v3
        with:
          path: studio
          fetch-depth: 1

      - name: 'Installing Dependencies'
        uses: ./studio/.github/actions/yarn-install
        with:
          install-path: studio

      - name: 'Building'
        working-directory: studio
        run: yarn build

      - name: Checkout Altinn-CDN repository
        uses: actions/checkout@v3
        with:
          repository: 'Altinn/altinn-cdn'
          branch: 'chore/studio'
          token: ${{secrets.ALTINN_CDN_TOKEN}}
          path: cdn

      - name: Run publish script
        working-directory: studio
        run: |
          bash .github/scripts/push-to-cdn.sh \
           --frontend ./frontend \
           --cdn ../cdn \
           --commit \

      - name: Push to CDN
        working-directory: cdn
        run: git push
